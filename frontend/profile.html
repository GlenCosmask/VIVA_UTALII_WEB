<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Profile - VIVA UTALII</title>
<style>
* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
}

body {
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    background: linear-gradient(135deg, #004e64, #007f5f, #d4af37);
    background-attachment: fixed;
    color: #fff;
    min-height: 100vh;
    overflow-x: hidden;
}

nav {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 1rem 2rem;
    background: rgba(0, 0, 0, 0.5);
    backdrop-filter: blur(10px);
    position: relative;
    z-index: 100;
}

nav .logo {
    font-size: 1.8rem;
    font-weight: bold;
    color: #ffd700;
    letter-spacing: 1px;
    text-transform: uppercase;
}

nav ul {
    list-style: none;
    display: flex;
    gap: 2rem;
    margin: 0;
    padding: 0;
}

nav ul li a {
    text-decoration: none;
    color: #fff;
    font-weight: 500;
    transition: .3s;
    padding: 0.5rem 0;
    position: relative;
}

nav ul li a:after {
    content: '';
    position: absolute;
    width: 0;
    height: 2px;
    bottom: 0;
    left: 0;
    background-color: #d4af37;
    transition: width 0.3s;
}

nav ul li a:hover {
    color: #d4af37;
}

nav ul li a:hover:after {
    width: 100%;
}

nav .logout-btn {
    background: #d4af37;
    border: none;
    padding: 0.7rem 1.5rem;
    border-radius: 30px;
    cursor: pointer;
    font-weight: bold;
    color: #004e64;
    transition: all 0.3s;
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
}

nav .logout-btn:hover {
    background: #ffd700;
    transform: translateY(-2px);
    box-shadow: 0 6px 12px rgba(0, 0, 0, 0.3);
}

.container {
    max-width: 1400px;
    margin: 2rem auto;
    display: grid;
    grid-template-columns: 1fr;
    gap: 2rem;
    padding: 0 2rem;
}

.user-card, .card {
    background: rgba(255, 255, 255, 0.1);
    padding: 1.5rem;
    border-radius: 20px;
    backdrop-filter: blur(10px);
    border: 1px solid rgba(255, 255, 255, 0.2);
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
    transition: transform 0.3s, box-shadow 0.3s;
}

.user-card:hover, .card:hover {
    transform: translateY(-5px);
    box-shadow: 0 12px 40px rgba(0, 0, 0, 0.3);
}

.user-card {
    display: flex;
    align-items: center;
    gap: 1.5rem;
}

.user-card img {
    width: 120px;
    height: 120px;
    border-radius: 50%;
    cursor: pointer;
    border: 3px solid #d4af37;
    object-fit: cover;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
    transition: transform 0.3s;
}

.user-card img:hover {
    transform: scale(1.05);
}

.user-card-details {
    display: flex;
    flex-direction: column;
    flex-grow: 1;
}

.user-card h2, .user-card p {
    margin: 0.2rem 0;
}

.user-card h2 {
    font-size: 1.8rem;
    color: #ffd700;
}

.btn {
    background: #d4af37;
    border: none;
    padding: 0.7rem 1.5rem;
    border-radius: 30px;
    cursor: pointer;
    font-weight: bold;
    margin-top: 1rem;
    width: max-content;
    color: #004e64;
    transition: all 0.3s;
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
}

.btn:hover {
    background: #ffd700;
    transform: translateY(-2px);
    box-shadow: 0 6px 12px rgba(0, 0, 0, 0.3);
}

.card h3 {
    margin-top: 0;
    color: #ffd700;
    font-size: 1.4rem;
    margin-bottom: 1rem;
    border-bottom: 1px solid rgba(255, 255, 255, 0.2);
    padding-bottom: 0.5rem;
}

.booking-actions button {
    background: #e74c3c;
    border: none;
    padding: 0.5rem 1rem;
    border-radius: 20px;
    cursor: pointer;
    color: #fff;
    margin-top: 0.5rem;
    transition: all 0.3s;
    font-weight: 500;
}

.booking-actions button:hover {
    background: #c0392b;
    transform: translateY(-2px);
}

.settings input, .settings select {
    padding: 0.7rem;
    margin: 0.5rem 0;
    border-radius: 10px;
    border: none;
    width: 100%;
    display: none;
    background: rgba(255, 255, 255, 0.9);
    color: #333;
}

.settings button {
    width: 100%;
    margin-top: 0.5rem;
    border-radius: 10px;
    padding: 0.7rem;
    font-weight: 500;
    transition: all 0.3s;
}

.settings button:not(.delete-btn) {
    background: rgba(255, 255, 255, 0.2);
    color: white;
    border: 1px solid rgba(255, 255, 255, 0.3);
}

.settings button:not(.delete-btn):hover {
    background: rgba(255, 255, 255, 0.3);
    transform: translateY(-2px);
}

.delete-btn {
    background: #e74c3c;
    color: white;
    border: none;
}

.delete-btn:hover {
    background: #c0392b;
    transform: translateY(-2px);
}

.popup {
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background: rgba(0, 0, 0, 0.8);
    padding: 2rem;
    border-radius: 20px;
    display: none;
    text-align: center;
    z-index: 1000;
    backdrop-filter: blur(10px);
    border: 1px solid rgba(255, 255, 255, 0.2);
    box-shadow: 0 12px 40px rgba(0, 0, 0, 0.4);
    max-width: 400px;
    width: 90%;
}

.popup button {
    margin-top: 1rem;
    border-radius: 20px;
    padding: 0.7rem 1.5rem;
}

.booking-item {
    margin-bottom: 1rem;
    padding: 1rem;
    background: rgba(255, 255, 255, 0.1);
    border-radius: 15px;
    transition: transform 0.3s;
}

.booking-item:hover {
    transform: translateX(5px);
    background: rgba(255, 255, 255, 0.15);
}

.destination-card {
    display: flex;
    gap: 1rem;
    align-items: center;
}

.destination-image {
    width: 80px;
    height: 60px;
    border-radius: 10px;
    object-fit: cover;
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
}

.destination-info {
    flex-grow: 1;
}

.offers-container {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
    gap: 1rem;
}

.offer-card {
    background: rgba(255, 255, 255, 0.15);
    border-radius: 15px;
    overflow: hidden;
    transition: transform 0.3s;
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
    cursor: pointer;
}

.offer-card:hover {
    transform: translateY(-5px);
}

.offer-image {
    width: 100%;
    height: 100px;
    object-fit: cover;
}

.offer-details {
    padding: 0.8rem;
}

.offer-details h4 {
    margin-bottom: 0.3rem;
    font-size: 0.9rem;
}

.offer-details p {
    font-size: 0.8rem;
    color: #ffd700;
}

.thank-you-message {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.8);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 2000;
    backdrop-filter: blur(10px);
    display: none;
}

.thank-you-card {
    background: rgba(255, 255, 255, 0.1);
    padding: 3rem;
    border-radius: 20px;
    text-align: center;
    max-width: 500px;
    width: 90%;
    backdrop-filter: blur(10px);
    border: 1px solid rgba(255, 255, 255, 0.2);
    box-shadow: 0 12px 40px rgba(0, 0, 0, 0.4);
}

.thank-you-card h2 {
    color: #ffd700;
    margin-bottom: 1rem;
    font-size: 2rem;
}

.thank-you-card p {
    margin-bottom: 2rem;
    line-height: 1.6;
}

.thank-you-card button {
    background: #d4af37;
    border: none;
    padding: 0.7rem 1.5rem;
    border-radius: 30px;
    cursor: pointer;
    font-weight: bold;
    color: #004e64;
    transition: all 0.3s;
}

.thank-you-card button:hover {
    background: #ffd700;
    transform: translateY(-2px);
}

.cancellation-confirmation {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.8);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 2000;
    backdrop-filter: blur(10px);
    display: none;
}

.confirmation-card {
    background: rgba(255, 255, 255, 0.1);
    padding: 2.5rem;
    border-radius: 20px;
    text-align: center;
    max-width: 450px;
    width: 90%;
    backdrop-filter: blur(10px);
    border: 1px solid rgba(255, 255, 255, 0.2);
    box-shadow: 0 12px 40px rgba(0, 0, 0, 0.4);
}

.confirmation-card h3 {
    color: #ffd700;
    margin-bottom: 1rem;
    font-size: 1.5rem;
}

.confirmation-card p {
    margin-bottom: 1.5rem;
    line-height: 1.6;
}

.confirmation-buttons {
    display: flex;
    gap: 1rem;
    justify-content: center;
}

.confirm-btn {
    background: #e74c3c;
    border: none;
    padding: 0.7rem 1.5rem;
    border-radius: 20px;
    cursor: pointer;
    color: #fff;
    font-weight: 500;
    transition: all 0.3s;
    flex: 1;
}

.confirm-btn:hover {
    background: #c0392b;
    transform: translateY(-2px);
}

.cancel-btn {
    background: rgba(255, 255, 255, 0.2);
    border: 1px solid rgba(255, 255, 255, 0.3);
    padding: 0.7rem 1.5rem;
    border-radius: 20px;
    cursor: pointer;
    color: #fff;
    font-weight: 500;
    transition: all 0.3s;
    flex: 1;
}

.cancel-btn:hover {
    background: rgba(255, 255, 255, 0.3);
    transform: translateY(-2px);
}

.cancellation-success {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.8);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 2000;
    backdrop-filter: blur(10px);
    display: none;
}

.success-card {
    background: rgba(255, 255, 255, 0.1);
    padding: 2.5rem;
    border-radius: 20px;
    text-align: center;
    max-width: 450px;
    width: 90%;
    backdrop-filter: blur(10px);
    border: 1px solid rgba(255, 255, 255, 0.2);
    box-shadow: 0 12px 40px rgba(0, 0, 0, 0.4);
}

.success-card h3 {
    color: #2ecc71;
    margin-bottom: 1rem;
    font-size: 1.5rem;
}

.success-card p {
    margin-bottom: 1.5rem;
    line-height: 1.6;
}

.success-card button {
    background: #d4af37;
    border: none;
    padding: 0.7rem 1.5rem;
    border-radius: 20px;
    cursor: pointer;
    color: #004e64;
    font-weight: bold;
    transition: all 0.3s;
}

.success-card button:hover {
    background: #ffd700;
    transform: translateY(-2px);
}

/* Additional styles for the bookings section */
.booking-status {
    display: inline-block;
    padding: 4px 8px;
    border-radius: 12px;
    font-size: 12px;
    font-weight: bold;
    margin-left: 8px;
}

.status-confirmed {
    background: rgba(46, 204, 113, 0.2);
    color: #2ecc71;
    border: 1px solid rgba(46, 204, 113, 0.3);
}

.status-pending {
    background: rgba(241, 196, 15, 0.2);
    color: #f1c40f;
    border: 1px solid rgba(241, 196, 15, 0.3);
}

.booking-details {
    font-size: 14px;
    opacity: 0.9;
    margin-top: 8px;
}

.booking-price {
    font-weight: bold;
    color: #ffd700;
    font-size: 16px;
}

.no-bookings {
    text-align: center;
    padding: 40px 20px;
    opacity: 0.8;
}

.no-bookings a {
    display: inline-block;
    margin-top: 15px;
}

/* NEW STYLES FOR BOOKINGS GRID SECTION */
.bookings-section {
    padding: 20px 0;
}

.bookings-section h2 {
    text-align: center;
    color: #d4af37;
    font-family: 'Playfair Display', serif;
    margin-bottom: 30px;
    font-size: 2rem;
}

.bookings-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: 20px;
    margin-top: 20px;
}

.booking-card {
    background: rgba(255,255,255,0.1);
    padding: 20px;
    border-radius: 15px;
    backdrop-filter: blur(8px);
    border: 1px solid rgba(255,255,255,0.2);
    transition: transform 0.3s, box-shadow 0.3s;
    display: flex;
    flex-direction: column;
    height: 100%;
}

.booking-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 8px 25px rgba(0,0,0,0.3);
}

.booking-card-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 15px;
    border-bottom: 1px solid rgba(255,255,255,0.2);
    padding-bottom: 10px;
}

.booking-card h3 {
    margin: 0;
    color: #d4af37;
    font-size: 1.2rem;
    flex: 1;
}

.booking-card-image {
    width: 100%;
    height: 150px;
    object-fit: cover;
    border-radius: 10px;
    margin-bottom: 15px;
}

.booking-card-details {
    flex: 1;
    margin-bottom: 15px;
}

.booking-detail-row {
    display: flex;
    justify-content: space-between;
    margin-bottom: 8px;
    font-size: 14px;
}

.booking-detail-label {
    font-weight: 600;
    color: rgba(255,255,255,0.8);
}

.booking-detail-value {
    text-align: right;
}

.booking-card-footer {
    border-top: 1px solid rgba(255,255,255,0.2);
    padding-top: 15px;
    margin-top: auto;
}

.booking-price-section {
    display: flex;
    justify-content: space-between;
    margin-bottom: 10px;
    font-weight: bold;
}

.booking-date {
    font-size: 12px;
    color: rgba(255,255,255,0.7);
    margin-top: 5px;
    text-align: center;
}

.cancel-booking-btn {
    background: #e74c3c;
    border: none;
    padding: 10px 15px;
    border-radius: 20px;
    cursor: pointer;
    color: #fff;
    font-weight: 500;
    transition: all 0.3s;
    width: 100%;
    margin-top: 10px;
}

.cancel-booking-btn:hover {
    background: #c0392b;
    transform: translateY(-2px);
}

@media (max-width: 768px) {
    nav {
        flex-direction: column;
        gap: 1rem;
        padding: 1rem;
    }
    
    nav ul {
        gap: 1rem;
    }
    
    .container {
        padding: 0 1rem;
    }
    
    .user-card {
        flex-direction: column;
        text-align: center;
    }
    
    .offers-container {
        grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
    }
    
    .confirmation-buttons {
        flex-direction: column;
    }
    
    .bookings-grid {
        grid-template-columns: 1fr;
    }
}

@media (min-width: 1200px) {
    .bookings-grid {
        grid-template-columns: repeat(4, 1fr);
    }
}
</style>
</head>
<body>
<nav>
  <div class="logo">VIVA UTALII</div>
  <ul>
    <li><a href="index.html">Home</a></li>
    <li><a href="destinations.html">Destinations</a></li>
    <li><a href="recommendations.html">Recommendations</a></li>
    <li><a href="about.html">About</a></li>
    <li><a href="contact.html">Contact</a></li>
  </ul>
  <button class="logout-btn" onclick="showThankYou()">Log Out</button>
</nav>

<div class="container">
  <div class="user-card">
    <img id="profilePic" src="images/ceo.jpg" alt="Profile Picture" onclick="editProfilePic()">
    <div class="user-card-details">
        <h2 id="userName">Loading...</h2>
        <p id="userEmail">Loading...</p>
        <button class="btn" onclick="generateNewsletter()">Your Monthly Newsletter</button>
    </div>
  </div>

  <!-- SINGLE BOOKINGS SECTION WITH GRID LAYOUT -->
  <section class="bookings-section">
    <h2>My Bookings</h2>
    <div class="bookings-grid" id="bookingsGrid">
        <!-- Bookings will be loaded here in grid format -->
    </div>
  </section>

  <div class="card">
    <h3>Travel History</h3>
    <div id="travelHistory">
        <p>Loading travel history...</p>
    </div>
  </div>

  <div class="card">
    <h3>Deals & Offers</h3>
    <div id="dealsList" class="offers-container">
        <!-- Offers will be loaded here -->
    </div>
  </div>

  <div class="card settings">
    <h3>Settings & Preferences</h3>
    <button onclick="toggleInput('newPassword')">Change Password</button>
    <input type="password" id="newPassword" placeholder="New Password">
    <button onclick="updatePassword()">Update Password</button>

    <button onclick="toggleInput('newEmail')">Change Email</button>
    <input type="email" id="newEmail" placeholder="New Email">
    <button onclick="updateEmail()">Update Email</button>

    <select id="notificationPref">
      <option value="all">All Notifications</option>
      <option value="none">No Notifications</option>
      <option value="newsletter">Only Newsletter</option>
    </select>
    <button onclick="updateNotificationPref()">Save Preferences</button>
    <button class="delete-btn" onclick="deleteAccount()">Delete Account</button>
  </div>
</div>

<div class="popup" id="popup">
  <p id="popupMessage"></p>
  <button onclick="closePopup()">OK</button>
</div>

<div class="thank-you-message" id="thankYouMessage">
  <div class="thank-you-card">
    <h2>Thank You!</h2>
    <p>We appreciate you using VIVA UTALII. We hope you had a wonderful experience and look forward to serving you again soon!</p>
    <button onclick="logout()">Continue</button>
  </div>
</div>

<div class="cancellation-confirmation" id="cancellationConfirmation">
  <div class="confirmation-card">
    <h3>Cancel Booking</h3>
    <p id="confirmationMessage">Are you sure you want to cancel this booking?</p>
    <div class="confirmation-buttons">
      <button class="confirm-btn" id="confirmCancel">Yes, Cancel</button>
      <button class="cancel-btn" onclick="closeCancellationConfirmation()">No, Keep Booking</button>
    </div>
  </div>
</div>

<div class="cancellation-success" id="cancellationSuccess">
  <div class="success-card">
    <h3>Booking Cancelled</h3>
    <p id="successMessage">Your booking has been successfully cancelled. Your deposit will be refunded within an hour.</p>
    <button onclick="closeCancellationSuccess()">OK</button>
  </div>
</div>

<!-- EmailJS SDK -->
<script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
<script>
// Initialize EmailJS with your public key
(function() {
    emailjs.init("PVuh_QoJ_cr04G6nd");
})();

// Base URL for your Flask backend
const API_BASE = 'http://127.0.0.1:5000';

// Get authentication token from localStorage
const authToken = localStorage.getItem('auth_token');
const userData = localStorage.getItem('user_data');

// Store the current booking being cancelled
let currentCancellationBooking = null;

// Helper function to create headers with authentication
function getAuthHeaders() {
    const headers = {
        'Content-Type': 'application/json'
    };
    
    // Add authorization header if token exists
    if (authToken) {
        headers['Authorization'] = `Bearer ${authToken}`;
    }
    
    return headers;
}

// Pre-populate user data if available
if (userData) {
    try {
        const user = JSON.parse(userData);
        document.getElementById('userName').textContent = user.name || 'User Name';
        document.getElementById('userEmail').textContent = user.email || 'user@email.com';
    } catch (e) {
        console.error('Error parsing user data:', e);
    }
}

// Set up automatic newsletter sending at end of month
function setupAutomaticNewsletter() {
    const now = new Date();
    const lastDayOfMonth = new Date(now.getFullYear(), now.getMonth() + 1, 0).getDate();
    
    // Check if today is the last day of the month
    if (now.getDate() === lastDayOfMonth) {
        // Check if we've already sent the newsletter today
        const lastSent = localStorage.getItem('lastNewsletterSent');
        const today = now.toDateString();
        
        if (lastSent !== today) {
            sendNewsletterEmail('monthly_automatic');
            localStorage.setItem('lastNewsletterSent', today);
        }
    }
}

// NEW FUNCTION: Load bookings in grid format
function loadBookingsGrid() {
    try {
        const container = document.getElementById('bookingsGrid');
        
        // Get bookings from localStorage
        const userBookings = JSON.parse(localStorage.getItem('userBookings') || '[]');
        const vuaBookings = JSON.parse(localStorage.getItem('vua_bookings') || '[]');
        
        console.log('User Bookings:', userBookings);
        console.log('VUA Bookings:', vuaBookings);
        
        // Transform vua_bookings to match userBookings format
        const transformedVuaBookings = vuaBookings.map(booking => {
            const bookingDate = booking.time || booking.bookingDate || new Date().toISOString();
            const nights = booking.nights || Math.round((new Date(booking.depart) - new Date(booking.arrive)) / (1000 * 60 * 60 * 24));
            
            return {
                id: booking.id || 'VU' + Date.now() + Math.random().toString(36).substr(2, 5),
                destination: booking.destName || booking.destination,
                startDate: booking.arrive || booking.startDate,
                endDate: booking.depart || booking.endDate,
                nights: nights,
                adults: booking.travelers || booking.adults || 1,
                children: booking.children || 0,
                accommodation: booking.accTier || booking.accommodation || 'Standard',
                transport: booking.transport || 'Not specified',
                totalCost: booking.total || booking.totalCost || 0,
                bookingFee: booking.deposit || booking.bookingFee || 0,
                status: booking.status || 'confirmed',
                bookingDate: bookingDate,
                contactEmail: booking.email || booking.contactEmail || document.getElementById('userEmail').textContent,
                phone: booking.phone || ''
            };
        });
        
        // Combine all bookings
        const allBookings = [...userBookings, ...transformedVuaBookings];
        
        console.log('All combined bookings:', allBookings);
        
        // Remove duplicates based on destination, dates, and booking ID
        const uniqueBookings = allBookings.filter((booking, index, self) =>
            index === self.findIndex(b => 
                b.id === booking.id || 
                (b.destination === booking.destination && 
                 b.startDate === booking.startDate &&
                 b.endDate === booking.endDate)
            )
        );
        
        if (uniqueBookings.length > 0) {
            container.innerHTML = '';
            
            // Sort bookings by date (newest first)
            uniqueBookings.sort((a, b) => new Date(b.bookingDate) - new Date(a.bookingDate));
            
            uniqueBookings.forEach(booking => {
                const bookingDate = new Date(booking.bookingDate);
                const formattedDate = bookingDate.toLocaleDateString('en-US', {
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });
                
                const statusClass = booking.status === 'confirmed' ? 'status-confirmed' : 'status-pending';
                const statusText = booking.status === 'confirmed' ? 'Confirmed' : 'Pending';
                const destinationImage = getDestinationImage(booking.destination);
                
                // Create a safe ID for the booking card
                const safeBookingId = booking.id.replace(/[^a-zA-Z0-9]/g, '-');
                
                container.innerHTML += `
                    <div class="booking-card" id="booking-card-${safeBookingId}">
                        <div class="booking-card-header">
                            <h3>${booking.destination}</h3>
                            <span class="booking-status ${statusClass}">${statusText}</span>
                        </div>
                        
                        <img src="${destinationImage}" alt="${booking.destination}" class="booking-card-image">
                        
                        <div class="booking-card-details">
                            <div class="booking-detail-row">
                                <span class="booking-detail-label">Booking ID:</span>
                                <span class="booking-detail-value">${booking.id}</span>
                            </div>
                            <div class="booking-detail-row">
                                <span class="booking-detail-label">Dates:</span>
                                <span class="booking-detail-value">${booking.startDate} to ${booking.endDate}</span>
                            </div>
                            <div class="booking-detail-row">
                                <span class="booking-detail-label">Duration:</span>
                                <span class="booking-detail-value">${booking.nights} nights</span>
                            </div>
                            <div class="booking-detail-row">
                                <span class="booking-detail-label">Travelers:</span>
                                <span class="booking-detail-value">${booking.adults} adults, ${booking.children} children</span>
                            </div>
                            <div class="booking-detail-row">
                                <span class="booking-detail-label">Accommodation:</span>
                                <span class="booking-detail-value">${booking.accommodation}</span>
                            </div>
                            <div class="booking-detail-row">
                                <span class="booking-detail-label">Transport:</span>
                                <span class="booking-detail-value">${booking.transport}</span>
                            </div>
                        </div>
                        
                        <div class="booking-card-footer">
                            <div class="booking-price-section">
                                <span>Total Cost:</span>
                                <span>Ksh ${booking.totalCost?.toLocaleString() || '0'}</span>
                            </div>
                            <div class="booking-price-section">
                                <span>Booking Fee Paid:</span>
                                <span>Ksh ${booking.bookingFee?.toLocaleString() || '0'}</span>
                            </div>
                            <div class="booking-date">
                                Booked on: ${formattedDate}
                            </div>
                            <button class="cancel-booking-btn" onclick="showCancellationConfirmation('${booking.id}', '${booking.destination.replace(/'/g, "\\'")}')">
                                Cancel Booking
                            </button>
                        </div>
                    </div>`;
            });
        } else {
            container.innerHTML = `
                <div class="no-bookings" style="grid-column: 1 / -1;">
                    <p>No bookings yet.</p>
                    <p style="margin-top: 10px; opacity: 0.8;">Your confirmed trips will appear here after successful payment.</p>
                    <a href="recommendations.html" class="btn" style="display: inline-block; margin-top: 15px;">
                        Explore Destinations
                    </a>
                </div>`;
        }
    } catch (error) {
        console.error('Error loading bookings grid:', error);
        document.getElementById('bookingsGrid').innerHTML = '<p>Error loading bookings. Please refresh the page.</p>';
    }
}

// Helper function to get destination image
function getDestinationImage(destName) {
    const imageMap = {
        'Diani Beach': 'images/diani1.avif',
        'Maasai Mara': 'images/mm3.avif',
        'Amboseli': 'images/amboseli1.avif',
        'Nairobi City': 'images/nnp2.avif',
        'Mount Kenya': 'images/mk1.jpg',
        'Diani': 'images/diani1.avif',
        'Maasai Mara': 'images/mm3.avif',
        'Amboseli': 'images/amboseli1.avif',
        'Mt. Kenya': 'images/mk1.jpg',
        'Nairobi National Park': 'images/nnp2.avif'
    };
    
    return imageMap[destName] || 'https://images.unsplash.com/photo-1488646953014-85cb44e25828?ixlib=rb-4.0.3&auto=format&fit=crop&w=300&q=80';
}

async function loadUserInfo(){
  try {
    const headers = getAuthHeaders();
    
    const res = await fetch(`${API_BASE}/get_user_info`, {
      credentials: 'include',
      headers: headers
    });
    
    if (!res.ok) {
      // If unauthorized, try to use stored user data
      if (res.status === 401 && userData) {
        const user = JSON.parse(userData);
        document.getElementById('userName').textContent = user.name || 'User Name';
        document.getElementById('userEmail').textContent = user.email || 'user@email.com';
        showPopup('Using cached user data. Please log in again for full functionality.');
        return;
      }
      throw new Error('Failed to fetch user info');
    }
    
    const data = await res.json();
    if (!data.error) {
      document.getElementById('userName').textContent = data.name || 'User Name';
      document.getElementById('userEmail').textContent = data.email || 'user@email.com';
      
      // Update localStorage with fresh data
      localStorage.setItem('user_data', JSON.stringify({
        name: data.name,
        email: data.email
      }));
    } else {
      document.getElementById('userName').textContent = 'Not logged in';
      document.getElementById('userEmail').textContent = 'Please log in';
    }
  } catch (error) {
    console.error('Error loading user info:', error);
    // Fallback to stored data
    if (userData) {
        const user = JSON.parse(userData);
        document.getElementById('userName').textContent = user.name || 'User Name';
        document.getElementById('userEmail').textContent = user.email || 'user@email.com';
        showPopup('Using cached data. Some features may not work.');
    } else {
        document.getElementById('userName').textContent = 'Error loading data';
        document.getElementById('userEmail').textContent = 'Please log in again';
    }
  }
  
  // Load other data
  loadTravelHistory();
  loadDeals();
  loadBookingsGrid(); // Load the new bookings grid
}

async function loadTravelHistory(){
  try {
    const headers = getAuthHeaders();
    
    const res = await fetch(`${API_BASE}/get_travel_history`, {
      credentials: 'include',
      headers: headers
    });
    
    if (!res.ok) {
      // If API fails, show message based on bookings
      const container = document.getElementById('travelHistory');
      const userBookings = JSON.parse(localStorage.getItem('userBookings') || '[]');
      const vuaBookings = JSON.parse(localStorage.getItem('vua_bookings') || '[]');
      
      if (userBookings.length > 0 || vuaBookings.length > 0) {
        container.innerHTML = '<p>Your upcoming trips will appear here as travel history after completion.</p>';
      } else {
        container.innerHTML = '<p>No travel history yet. Start exploring destinations and complete your first trip!</p>';
      }
      return;
    }
    
    const data = await res.json();
    const container = document.getElementById('travelHistory');
    
    if (data && data.length > 0) {
      container.innerHTML = '';
      data.forEach(trip => {
        container.innerHTML += `
          <div class="booking-item">
            <p><strong>${trip.destination}</strong><br>
            Dates: ${trip.start_date || 'N/A'} - ${trip.end_date || 'N/A'}<br>
            Status: ${trip.status || 'Completed'}</p>
          </div>`;
      });
    } else {
      container.innerHTML = '<p>No travel history yet. Start exploring destinations and complete your first trip!</p>';
    }
  } catch (error) {
    console.error('Error loading travel history:', error);
    const container = document.getElementById('travelHistory');
    container.innerHTML = '<p>No travel history yet. Your upcoming trips will appear here after completion.</p>';
  }
}

async function loadDeals(){
  try {
    const headers = getAuthHeaders();
    
    const res = await fetch(`${API_BASE}/get_deals`, {
      credentials: 'include',
      headers: headers
    });
    
    const data = await res.json();
    const container = document.getElementById('dealsList');
    
    if (data && data.length > 0) {
      container.innerHTML = '';
      data.forEach(d => {
        container.innerHTML += `
          <div class="offer-card" onclick="redirectToDestination('${d.destination}')">
            <img class="offer-image" src="${d.image || getDefaultImage(d.destination)}" alt="${d.destination}">
            <div class="offer-details">
              <h4>${d.destination}</h4>
              <p>${d.discount}</p>
            </div>
          </div>`;
      });
    } else {
      // Load default offers if no deals from API
      loadDefaultOffers();
    }
  } catch (error) {
    console.error('Error loading deals:', error);
    // Load default offers if API fails
    loadDefaultOffers();
  }
}

// Function to load default offers
function loadDefaultOffers() {
  const container = document.getElementById('dealsList');
  container.innerHTML = '';
  
  const defaultOffers = [
    { destination: "Maasai Mara", discount: "20% Off", image: "images/mm1.avif", link: "maasaimara.html" },
    { destination: "Diani Beach", discount: "15% Off", image: "images/diani1.avif", link: "diani.html" },
    { destination: "Mt. Kenya", discount: "25% Off", image: "images/mk1.jpg", link: "mtkenya.html" },
    { destination: "Nairobi NP", discount: "10% Off", image: "images/nnp2.avif", link: "nairobi.html" }
  ];
  
  defaultOffers.forEach(offer => {
    container.innerHTML += `
      <div class="offer-card" onclick="redirectToPage('${offer.link}')">
        <img class="offer-image" src="${offer.image}" alt="${offer.destination}">
        <div class="offer-details">
          <h4>${offer.destination}</h4>
          <p>${offer.discount}</p>
        </div>
      </div>`;
  });
}

// Function to get default image based on destination
function getDefaultImage(destination) {
  const imageMap = {
    "Maasai Mara": "images/mm1.avif",
    "Diani Beach": "images/diani1.avif",
    "Mt. Kenya": "images/mk1.jpg",
    "Nairobi NP": "images/nnp2.avif"
  };
  
  return imageMap[destination] || 'https://images.unsplash.com/photo-1488646953014-85cb44e25828?ixlib=rb-4.0.3&auto=format&fit=crop&w=200&q=80';
}

// Function to redirect to destination page
function redirectToDestination(destination) {
  const destinationMap = {
    "Maasai Mara": "maasaimara.html",
    "Diani Beach": "diani.html",
    "Mt. Kenya": "mtkenya.html",
    "Nairobi NP": "nairobi.html"
  };
  
  const link = destinationMap[destination];
  if (link) {
    window.location.href = link;
  }
}

// Function to redirect to specific page
function redirectToPage(page) {
  window.location.href = page;
}

// Enhanced cancellation flow
function showCancellationConfirmation(bookingId, destination) {
  currentCancellationBooking = { id: bookingId, destination: destination };
  document.getElementById('confirmationMessage').textContent = `Are you sure you want to cancel your booking for ${destination}?`;
  document.getElementById('cancellationConfirmation').style.display = 'flex';
  
  // Set up the confirmation button
  document.getElementById('confirmCancel').onclick = function() {
    processCancellation(bookingId, destination);
  };
}

function closeCancellationConfirmation() {
  document.getElementById('cancellationConfirmation').style.display = 'none';
  currentCancellationBooking = null;
}

function closeCancellationSuccess() {
  document.getElementById('cancellationSuccess').style.display = 'none';
  // Refresh the bookings grid
  loadBookingsGrid();
}

function processCancellation(bookingId, destination) {
  try {
    console.log('Processing cancellation for booking:', bookingId, destination);
    
    // Remove from userBookings
    const userBookings = JSON.parse(localStorage.getItem('userBookings') || '[]');
    const updatedUserBookings = userBookings.filter(booking => {
      const keep = booking.id !== bookingId;
      if (!keep) {
        console.log('Removing from userBookings:', booking);
      }
      return keep;
    });
    localStorage.setItem('userBookings', JSON.stringify(updatedUserBookings));
    
    // Remove from vua_bookings
    const vuaBookings = JSON.parse(localStorage.getItem('vua_bookings') || '[]');
    const updatedVuaBookings = vuaBookings.filter(booking => {
      const keep = booking.id !== bookingId && 
                  !(booking.destName === destination && !booking.id);
      if (!keep) {
        console.log('Removing from vua_bookings:', booking);
      }
      return keep;
    });
    localStorage.setItem('vua_bookings', JSON.stringify(updatedVuaBookings));
    
    // Close confirmation and show success message
    closeCancellationConfirmation();
    
    // Update the success message
    document.getElementById('successMessage').textContent = 
      `Your booking for ${destination} has been successfully cancelled. Your deposit will be refunded within an hour.`;
    
    // Show success message
    document.getElementById('cancellationSuccess').style.display = 'flex';
    
    console.log('Cancellation completed successfully');
    
  } catch (error) {
    console.error('Error cancelling booking:', error);
    closeCancellationConfirmation();
    showPopup('Error cancelling booking. Please try again.');
  }
}

// Load user data when page loads
document.addEventListener('DOMContentLoaded', function() {
    loadUserInfo();
    setupAutomaticNewsletter();
});

function showThankYou() {
  document.getElementById('thankYouMessage').style.display = 'flex';
}

function logout(){
  // Clear localStorage and redirect to index.html
  localStorage.removeItem('auth_token');
  localStorage.removeItem('user_data');
  window.location.href = 'index.html';
}

function editProfilePic(){
  const newPic = prompt("Enter URL of new profile picture:");
  if(newPic) {
    document.getElementById('profilePic').src = newPic;
    showPopup('Profile picture updated!');
  }
}

async function generateNewsletter(){
  try {
    const headers = getAuthHeaders();
    
    const res = await fetch(`${API_BASE}/generate_newsletter`, {
      method: 'POST',
      credentials: 'include',
      headers: headers
    });
    
    if (!res.ok) {
      throw new Error('Failed to generate newsletter');
    }
    
    const data = await res.json();
    
    // Send newsletter email using EmailJS
    await sendNewsletterEmail('manual_request');
    showPopup('Newsletter generated and sent to your email!');
  } catch (error) {
    console.error('Error generating newsletter:', error);
    showPopup('Error generating newsletter. Please log in again.');
  }
}

// Function to send newsletter email using EmailJS
async function sendNewsletterEmail(type) {
  try {
    const userEmail = document.getElementById('userEmail').textContent;
    const userName = document.getElementById('userName').textContent;
    
    // Don't send to example emails or when not logged in
    if (userEmail.includes('@example.com') || userEmail === 'Loading...' || userEmail === 'Please log in') {
      showPopup('Please use a real email account to receive newsletters.');
      return false;
    }
    
    const templateParams = {
      to_email: userEmail,                    // Goes to To Email field
      to_name: userName,                      // Used in content as {{to_name}}
      month: new Date().toLocaleString('default', { month: 'long' }),
      year: new Date().getFullYear(),
      newsletter_type: type
    };
    
    console.log('Sending newsletter to:', userEmail);
    console.log('Template params:', templateParams);
    
    const response = await emailjs.send("service_atd4lt4", "template_41qxsdb", templateParams);
    console.log('✅ Newsletter sent successfully!');
    return true;
    
  } catch (error) {
    console.error('❌ Failed to send newsletter:', error);
    showPopup('Failed to send newsletter: ' + error.text);
    return false;
  }
}

function showPopup(message){
  document.getElementById('popupMessage').textContent = message;
  document.getElementById('popup').style.display = 'block';
}

function closePopup(){
  document.getElementById('popup').style.display = 'none';
}

async function updatePassword(){
  const newPass = document.getElementById('newPassword').value;
  if (!newPass) {
    showPopup('Please enter a new password');
    return;
  }
  
  try {
    const headers = getAuthHeaders();
    
    const res = await fetch(`${API_BASE}/update_password`, {
      method: 'POST',
      headers: headers,
      credentials: 'include',
      body: JSON.stringify({newPassword: newPass})
    });
    
    if (!res.ok) {
      throw new Error('Failed to update password');
    }
    
    const data = await res.json();
    showPopup(data.message);
    document.getElementById('newPassword').value = '';
    document.getElementById('newPassword').style.display = 'none';
  } catch (error) {
    showPopup('Error updating password. Please log in again.');
  }
}

async function updateEmail(){
  const newEmail = document.getElementById('newEmail').value;
  if (!newEmail) {
    showPopup('Please enter a new email');
    return;
  }
  
  try {
    const headers = getAuthHeaders();
    
    const res = await fetch(`${API_BASE}/update_email`, {
      method: 'POST',
      headers: headers,
      credentials: 'include',
      body: JSON.stringify({newEmail})
    });
    
    if (!res.ok) {
        throw new Error('Failed to update email');
    }
    
    const data = await res.json();
    showPopup(data.message);
    if (data.message.includes('successfully')) {
      // Update localStorage with new email
      const userData = JSON.parse(localStorage.getItem('user_data') || '{}');
      userData.email = newEmail;
      localStorage.setItem('user_data', JSON.stringify(userData));
      
      loadUserInfo(); // Refresh user info to show new email
    }
    document.getElementById('newEmail').value = '';
    document.getElementById('newEmail').style.display = 'none';
  } catch (error) {
    showPopup('Error updating email. Please log in again.');
  }
}

async function updateNotificationPref(){
  const pref = document.getElementById('notificationPref').value;
  showPopup('Notification preferences saved!');
}

async function deleteAccount(){
  if(confirm('Are you sure you want to delete your account? This action cannot be undone.')) {
    try {
      const headers = getAuthHeaders();
      
      const res = await fetch(`${API_BASE}/delete_account`, {
        method: 'POST',
        credentials: 'include',
        headers: headers
      });
      
      if (!res.ok) {
        throw new Error('Failed to delete account');
      }
      
      const data = await res.json();
      showPopup(data.message);
      
      // Clear localStorage and redirect
      localStorage.removeItem('auth_token');
      localStorage.removeItem('user_data');
      localStorage.removeItem('vua_bookings'); // Also clear bookings
      localStorage.removeItem('userBookings'); // Also clear new bookings
      setTimeout(() => window.location.href = 'index.html', 2000);
    } catch (error) {
      showPopup('Error deleting account. Please log in again.');
    }
  }
}

function toggleInput(id){
  const input = document.getElementById(id);
  input.style.display = input.style.display === 'block' ? 'none' : 'block';
}
</script>
</body>
</html>